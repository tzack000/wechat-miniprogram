# 云存储配置指南

## 存储桶结构

本项目使用两个云存储桶来分别管理不同类型的音频文件:

### 1. recordings (录音文件存储桶)
**用途**: 存储用户录制的声音样本

**配置**:
- 存储桶名称: `recordings`
- 权限: 私有读写
- 生命周期: 永久保存(除非用户删除)
- 目录结构:
  ```
  recordings/
  ├── {userId}/
  │   ├── {timestamp}_original.mp3  # 原始录音
  │   ├── {timestamp}_processed.wav # 转换后的音频
  │   └── metadata.json              # 录音元数据
  ```

**权限设置**:
```json
{
  "permission": "PRIVATE",
  "acl": {
    "read": ["CREATOR"],
    "write": ["CREATOR", "ADMIN"]
  }
}
```

### 2. audio-outputs (生成音频存储桶)
**用途**: 存储 TTS 生成的音频文件

**配置**:
- 存储桶名称: `audio-outputs`
- 权限: 私有读写
- 生命周期: 30天自动删除(收藏除外)
- 目录结构:
  ```
  audio-outputs/
  ├── {userId}/
  │   ├── {taskId}.mp3     # 生成的音频
  │   └── {taskId}.json    # 音频元数据
  ```

**权限设置**:
```json
{
  "permission": "PRIVATE",
  "acl": {
    "read": ["CREATOR"],
    "write": ["SERVICE"]
  }
}
```

## 在微信云开发控制台创建存储桶

### 步骤1: 打开云开发控制台
1. 在微信开发者工具中,点击"云开发"按钮
2. 进入云开发控制台
3. 选择"云存储"标签

### 步骤2: 创建存储桶
目前微信云开发只有一个默认的云存储空间,我们通过文件夹结构来分隔:

```
cloud://your-env-id.xxxx/
├── recordings/          # 录音文件目录
│   └── {userId}/
└── audio-outputs/       # 生成音频目录
    └── {userId}/
```

### 步骤3: 配置存储权限
在云开发控制台 -> 云存储 -> 权限设置:
- 选择"仅创建者可读写"
- 勾选"仅小程序端可上传"

## 存储空间配额

### 用户配额
- 单用户最大存储: 100MB
- 录音文件: 每个最大 10MB
- 生成音频: 每个最大 5MB

### 全局配额
- 总存储空间: 根据云开发套餐
- 免费配额: 5GB/月
- 超出部分: 按量计费

## CDN 加速配置

### 步骤1: 开启 CDN
1. 云开发控制台 -> 设置 -> CDN 加速
2. 开启"云存储 CDN 加速"
3. 配置自定义域名(可选)

### 步骤2: 配置缓存策略
- 音频文件(.mp3, .wav): 缓存时长 7 天
- 元数据文件(.json): 缓存时长 1 小时

### 步骤3: 配置防盗链
- 开启 Referer 防盗链
- 白名单: 小程序域名

## 文件命名规范

### 录音文件
格式: `{userId}/{timestamp}_{type}.{ext}`
示例: `user123/1704038400000_original.mp3`

### 生成音频
格式: `{userId}/{taskId}.{ext}`
示例: `user123/task_abc123.mp3`

### 临时文件
格式: `temp/{userId}/{timestamp}_{random}.{ext}`
示例: `temp/user123/1704038400000_x7k2p.mp3`

## 安全建议

1. **访问控制**
   - 所有文件使用签名 URL 访问
   - 签名有效期: 24 小时
   - 禁止直接访问原始 URL

2. **上传限制**
   - 文件大小限制: 10MB
   - 文件类型限制: mp3, wav, aac, m4a
   - 上传频率限制: 每用户每分钟最多 5 次

3. **下载限制**
   - 使用临时链接
   - 限制并发下载数
   - 监控异常下载行为

4. **数据备份**
   - 定期备份到云端备份服务
   - 保留30天的备份历史
   - 支持按需恢复

## 监控和告警

### 关键指标
- 存储空间使用率
- 上传/下载流量
- CDN 命中率
- 错误率

### 告警规则
- 存储空间使用超过 80%: 警告
- 存储空间使用超过 95%: 严重
- 单用户上传频率异常: 警告
- CDN 错误率超过 5%: 警告

## 成本优化

1. **自动清理过期文件**
   - 每天凌晨3点运行清理任务
   - 删除30天未访问的非收藏文件
   - 删除失败任务的临时文件

2. **压缩优化**
   - 音频文件使用高效压缩格式
   - 元数据文件压缩存储

3. **智能缓存**
   - 热门音频使用 CDN 缓存
   - 冷门音频按需加载
