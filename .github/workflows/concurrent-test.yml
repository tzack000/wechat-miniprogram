name: Concurrent Booking Tests

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'cloudfunctions/course/**'
      - 'cloudfunctions/testConcurrentBooking/**'
      - 'tests/**'
      - '.github/workflows/concurrent-test.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'cloudfunctions/course/**'
      - 'cloudfunctions/testConcurrentBooking/**'
      - 'tests/**'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      concurrency:
        description: 'å¹¶å‘æµ‹è¯•æ•°é‡'
        required: false
        default: '20'

jobs:
  concurrent-test:
    name: å¹¶å‘é¢„çº¦æµ‹è¯•
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: å®‰è£…ä¾èµ–
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        elif [ -f package.json ]; then
          npm install
        else
          echo "æ— éœ€å®‰è£…ä¾èµ–"
        fi
    
    - name: è¿è¡Œå¹¶å‘é¢„çº¦æ¨¡æ‹Ÿæµ‹è¯•
      id: concurrent-test
      run: |
        echo "========================================="
        echo "å¹¶å‘é¢„çº¦å’Œåé¢æ§åˆ¶æµ‹è¯•"
        echo "Node.js ç‰ˆæœ¬: ${{ matrix.node-version }}"
        echo "========================================="
        node tests/simulate_concurrent_test.js | tee test-output.txt
        
        # æ£€æŸ¥æµ‹è¯•æ˜¯å¦é€šè¿‡
        if grep -q "æ‰€æœ‰æµ‹è¯•é€šè¿‡" test-output.txt; then
          echo "test_status=passed" >> $GITHUB_OUTPUT
          echo "âœ… æµ‹è¯•é€šè¿‡"
        else
          echo "test_status=failed" >> $GITHUB_OUTPUT
          echo "âŒ æµ‹è¯•å¤±è´¥"
          exit 1
        fi
    
    - name: ç”Ÿæˆæµ‹è¯•æ‘˜è¦
      if: always()
      run: |
        echo "## å¹¶å‘é¢„çº¦æµ‹è¯•ç»“æœ ğŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Node.js ç‰ˆæœ¬**: ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f test-output.txt ]; then
          echo "### æµ‹è¯•è¾“å‡º" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 30 test-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**çŠ¶æ€**: ${{ steps.concurrent-test.outputs.test_status }}" >> $GITHUB_STEP_SUMMARY
    
    - name: ä¸Šä¼ æµ‹è¯•è¾“å‡º
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-output-node-${{ matrix.node-version }}
        path: test-output.txt
        retention-days: 30
    
    - name: è¯„è®ºPRï¼ˆå¦‚æœæ˜¯PRï¼‰
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const output = fs.readFileSync('test-output.txt', 'utf8');
          const status = '${{ steps.concurrent-test.outputs.test_status }}';
          const emoji = status === 'passed' ? 'âœ…' : 'âŒ';
          
          // æå–å…³é”®ä¿¡æ¯
          const lines = output.split('\n');
          const summaryStart = lines.findIndex(l => l.includes('æ€»ç»“æŠ¥å‘Š'));
          const summary = summaryStart >= 0 ? lines.slice(summaryStart, summaryStart + 15).join('\n') : '';
          
          const comment = `## ${emoji} å¹¶å‘é¢„çº¦æµ‹è¯•æŠ¥å‘Š
          
**Node.js ç‰ˆæœ¬**: ${{ matrix.node-version }}
**çŠ¶æ€**: ${status === 'passed' ? 'é€šè¿‡' : 'å¤±è´¥'}

### æµ‹è¯•æ‘˜è¦

\`\`\`
${summary}
\`\`\`

<details>
<summary>æŸ¥çœ‹å®Œæ•´è¾“å‡º</summary>

\`\`\`
${output.slice(-2000)}
\`\`\`

</details>

---
*ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
    
    - name: æ£€æŸ¥ä»£ç æ ¼å¼
      run: |
        echo "æ£€æŸ¥JavaScriptä»£ç æ ¼å¼..."
        
        # æ£€æŸ¥æµ‹è¯•æ–‡ä»¶
        if [ -d tests ]; then
          find tests -name "*.js" -type f | while read file; do
            echo "æ£€æŸ¥: $file"
            node -c "$file" || exit 1
          done
        fi
        
        # æ£€æŸ¥äº‘å‡½æ•°
        if [ -d cloudfunctions ]; then
          find cloudfunctions -name "*.js" -type f | while read file; do
            echo "æ£€æŸ¥: $file"
            node -c "$file" || exit 1
          done
        fi
        
        echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
    
    - name: ç»Ÿè®¡ä»£ç è¡Œæ•°
      run: |
        echo "## ä»£ç ç»Ÿè®¡ ğŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æµ‹è¯•ä»£ç " >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        find tests -name "*.js" -exec wc -l {} + | tail -1 >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### äº‘å‡½æ•°ä»£ç " >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        find cloudfunctions -name "*.js" -exec wc -l {} + | tail -1 >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  notification:
    name: æµ‹è¯•å®Œæˆé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [concurrent-test, code-quality]
    if: always()
    
    steps:
    - name: ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
      run: |
        echo "## ğŸ¯ CI/CD æµæ°´çº¿å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**å¹¶å‘æµ‹è¯•**: ${{ needs.concurrent-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**ä»£ç è´¨é‡**: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.concurrent-test.result }}" == "success" ] && [ "${{ needs.code-quality.result }}" == "success" ]; then
          echo "### âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä»£ç å¯ä»¥å®‰å…¨åˆå¹¶ã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ å­˜åœ¨å¤±è´¥çš„æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥å¤±è´¥çš„ä»»åŠ¡å¹¶ä¿®å¤é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
