# 课程预约功能部署和测试指南

## 📋 部署前检查清单

- [ ] 微信开发者工具已安装并登录
- [ ] 项目已在微信开发者工具中打开
- [ ] 云开发环境已开通
- [ ] 已有管理员账号（用于测试管理功能）

## 🚀 部署步骤

### 第一步：部署云函数

#### 1. 部署 coach 云函数

在微信开发者工具中：

```
1. 找到 cloudfunctions/coach 目录
2. 右键点击该目录
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成（状态变为绿色✓）
```

**验证部署**：
- 在云开发控制台 → 云函数 → 查看 coach 函数
- 状态应显示为"部署成功"

#### 2. 部署 course 云函数

```
1. 找到 cloudfunctions/course 目录
2. 右键点击该目录
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成（状态变为绿色✓）
```

**验证部署**：
- 在云开发控制台 → 云函数 → 查看 course 函数
- 状态应显示为"部署成功"

### 第二步：创建数据库集合

在云开发控制台 → 数据库：

#### 1. 创建 coaches 集合
```
1. 点击"+" 创建集合
2. 集合名称：coaches
3. 点击确定
```

**设置权限**：
- 点击集合 → 权限设置
- 读权限：`true`
- 写权限：`false`

#### 2. 创建 courses 集合
```
集合名称：courses
读权限：true
写权限：false
```

#### 3. 创建 course_schedules 集合
```
集合名称：course_schedules
读权限：true
写权限：false
```

#### 4. 创建 course_bookings 集合
```
集合名称：course_bookings
读权限：doc._openid == auth.openid
写权限：doc._openid == auth.openid
```

### 第三步：添加索引

为提升查询性能，建议添加以下索引：

#### coaches 集合
- `enabled` (单字段索引)
- `specialties` (单字段索引)

#### courses 集合
- `type` (单字段索引)
- `enabled` (单字段索引)

#### course_schedules 集合
- `courseId` (单字段索引)
- `coachId` (单字段索引)
- `date` (单字段索引)
- `status` (单字段索引)
- `courseId, date` (复合索引)

#### course_bookings 集合
- `_openid` (单字段索引)
- `scheduleId` (单字段索引)
- `courseId` (单字段索引)
- `date` (单字段索引)
- `status` (单字段索引)
- `scheduleId, _openid` (唯一复合索引)

### 第四步：导入测试数据

#### 方式一：使用初始化云函数（推荐）

1. 部署 initCourseData 云函数
2. 在云开发控制台调用该函数
3. 等待初始化完成

#### 方式二：手动导入

##### 1. 导入教练数据
```
1. 打开 coaches 集合
2. 点击"导入"
3. 选择 database/test_data/coaches.json
4. 导入格式：JSON
5. 冲突处理：插入
6. 点击确定
```

记录教练的 _id，例如：
- 张教练（瑜伽）：`coach_id_1`
- 李教练（游泳）：`coach_id_2`
- 王教练（篮球）：`coach_id_3`
- 刘教练（健身）：`coach_id_4`
- 陈教练（舞蹈）：`coach_id_5`

##### 2. 导入课程数据

**重要**：先修改 `database/test_data/courses.json`，将占位符替换为实际教练 ID：

```json
// 修改前
"coachIds": ["COACH_ID_1_PLACEHOLDER"]

// 修改后（使用实际的教练 _id）
"coachIds": ["6791a2b4c823456789abcdef"]
```

然后导入：
```
1. 打开 courses 集合
2. 点击"导入"
3. 选择修改后的 courses.json
4. 导入
```

##### 3. 创建课程排期

在云开发控制台手动添加或通过云函数创建，例如：

```javascript
// 在云开发控制台 → 云函数 → course
// 调试窗口输入：
{
  "action": "addSchedule",
  "scheduleData": {
    "courseId": "实际的课程ID",
    "coachId": "实际的教练ID",
    "date": "2026-01-20",
    "startTime": "10:00",
    "endTime": "11:00",
    "maxStudents": 15,
    "venueId": null
  }
}
```

## 🧪 功能测试

### 测试前准备

1. **登录小程序**
   - 在开发者工具中点击"编译"
   - 使用测试账号登录

2. **确认数据**
   - 至少有1个教练
   - 至少有1个课程
   - 至少有1个未来的排期

### 测试用例清单

#### 测试1：浏览课程列表
```
步骤：
1. 打开小程序首页
2. 点击"课程预约"
3. 查看课程列表

预期结果：
✓ 显示课程列表
✓ 显示课程图片、名称、类型、价格、时长
✓ 可以按类型筛选
✓ 下拉刷新有效
```

#### 测试2：查看课程详情
```
步骤：
1. 在课程列表点击任一课程
2. 查看课程详情

预期结果：
✓ 显示课程完整信息
✓ 显示可授课的教练列表
✓ 显示未来7天的日期选择器
✓ 默认加载今天的排期
```

#### 测试3：选择教练和日期
```
步骤：
1. 在课程详情页选择不同教练
2. 选择不同日期
3. 观察排期列表变化

预期结果：
✓ 点击"全部"显示所有教练的排期
✓ 点击特定教练只显示该教练的排期
✓ 切换日期时排期正确更新
✓ 显示剩余名额
```

#### 测试4：预约课程
```
步骤：
1. 在课程详情页选择一个有名额的排期
2. 点击"预约"按钮
3. 填写预约信息：
   - 姓名：张三
   - 手机号：13800138000
   - 备注：第一次上课
4. 点击"确认预约"

预期结果：
✓ 表单验证有效（空值、手机号格式）
✓ 提交成功后显示"预约成功"
✓ 自动跳转到"我的课程"页面
✓ 排期的剩余名额减1
```

#### 测试5：并发预约测试
```
步骤：
1. 找一个只剩1个名额的排期
2. 同时用2个账号点击预约
3. 几乎同时提交预约

预期结果：
✓ 只有1个预约成功
✓ 另一个提示"名额已满"
✓ 排期状态变为"已满"
✓ 不会出现超额预约
```

#### 测试6：重复预约检测
```
步骤：
1. 预约一个课程
2. 尝试再次预约同一场次

预期结果：
✓ 系统提示"您已预约该场次课程"
✓ 无法重复预约
```

#### 测试7：查看我的预约
```
步骤：
1. 点击个人中心
2. 点击"我的课程"
3. 查看预约列表

预期结果：
✓ 显示所有预约记录
✓ 显示课程名称、教练、时间、状态
✓ 可以按状态筛选（全部/已预约/已完成/已取消）
✓ 下拉刷新有效
```

#### 测试8：取消预约（距离>2小时）
```
步骤：
1. 在"我的课程"找一个距离开始时间>2小时的预约
2. 点击"取消预约"按钮
3. 确认取消

预期结果：
✓ 显示确认对话框
✓ 确认后预约状态变为"已取消"
✓ 排期的剩余名额+1
✓ 列表自动刷新
```

#### 测试9：取消预约（距离<2小时）
```
步骤：
1. 找一个距离开始时间<2小时的预约
2. 尝试点击"取消预约"

预期结果：
✓ 不显示"取消预约"按钮
✓ 或提示"已超过可取消时间"
```

#### 测试10：空状态展示
```
步骤：
1. 查看没有课程的列表
2. 查看没有排期的日期
3. 查看没有预约的"我的课程"

预期结果：
✓ 显示友好的空状态提示
✓ 显示引导操作按钮
```

### 性能测试

#### 测试11：加载速度
```
检查项：
- 课程列表首屏加载时间 < 2秒
- 课程详情页加载时间 < 1.5秒
- 排期切换响应时间 < 500ms
```

#### 测试12：分页加载
```
步骤：
1. 滚动到列表底部
2. 观察是否触发加载更多

预期结果：
✓ 自动加载下一页
✓ 显示加载状态
✓ 到最后一页提示"没有更多了"
```

## 🐛 常见问题排查

### 问题1：云函数调用失败
```
症状：页面提示"加载失败"

排查步骤：
1. 检查云函数是否部署成功
   - 云开发控制台 → 云函数 → 查看状态
2. 查看云函数日志
   - 云函数 → 日志 → 查看错误信息
3. 检查云函数代码
   - 确认 wx-server-sdk 版本
   - 确认数据库初始化正确

解决方案：
- 重新部署云函数
- 检查并修复代码错误
- 查看详细错误日志
```

### 问题2：集合权限错误
```
症状：提示"权限错误"或"没有权限访问"

排查步骤：
1. 检查集合权限设置
2. 确认用户已登录
3. 查看云函数中的权限检查逻辑

解决方案：
- 按照部署指南重新设置权限
- 确保用户正确登录
```

### 问题3：数据不显示
```
症状：列表为空但确认有数据

排查步骤：
1. 在云开发控制台查看集合数据
2. 检查数据的 enabled 字段
3. 查看云函数返回的数据
4. 检查前端数据绑定

解决方案：
- 确认数据已正确导入
- 确认 enabled 字段为 true
- 检查数据结构是否匹配
```

### 问题4：预约失败
```
症状：点击预约后提示失败

排查步骤：
1. 查看云函数日志中的错误信息
2. 检查排期是否还有名额
3. 检查用户是否已预约
4. 检查事务是否正常

解决方案：
- 根据错误信息修复
- 确认排期状态正确
- 检查数据库事务支持
```

### 问题5：名额控制不准确
```
症状：预约人数超过最大限制

排查步骤：
1. 检查 course 云函数中的 book 函数
2. 确认使用了数据库事务
3. 查看 bookedCount 更新逻辑

解决方案：
- 确保使用了事务
- 检查并发处理逻辑
- 重新同步名额数据
```

## 📊 测试记录模板

### 测试环境
- 日期：______
- 测试人：______
- 小程序版本：______
- 云函数版本：______

### 测试结果

| 测试用例 | 结果 | 备注 |
|---------|------|------|
| 测试1：浏览课程列表 | ☐ 通过 ☐ 失败 | |
| 测试2：查看课程详情 | ☐ 通过 ☐ 失败 | |
| 测试3：选择教练和日期 | ☐ 通过 ☐ 失败 | |
| 测试4：预约课程 | ☐ 通过 ☐ 失败 | |
| 测试5：并发预约测试 | ☐ 通过 ☐ 失败 | |
| 测试6：重复预约检测 | ☐ 通过 ☐ 失败 | |
| 测试7：查看我的预约 | ☐ 通过 ☐ 失败 | |
| 测试8：取消预约（>2h） | ☐ 通过 ☐ 失败 | |
| 测试9：取消预约（<2h） | ☐ 通过 ☐ 失败 | |
| 测试10：空状态展示 | ☐ 通过 ☐ 失败 | |
| 测试11：加载速度 | ☐ 通过 ☐ 失败 | |
| 测试12：分页加载 | ☐ 通过 ☐ 失败 | |

### 发现的问题

1. 
2. 
3. 

### 改进建议

1. 
2. 
3. 

## ✅ 部署验收标准

部署成功的标准：

- [x] coach 云函数部署成功
- [x] course 云函数部署成功
- [x] 4个数据库集合创建成功
- [x] 集合权限设置正确
- [x] 测试数据导入成功
- [x] 至少有3个课程排期
- [x] 用户可以浏览课程列表
- [x] 用户可以预约课程
- [x] 用户可以查看和取消预约
- [x] 并发预约不会超额
- [x] 重复预约被阻止

全部通过后，课程预约功能即可投入使用！ 🎉
