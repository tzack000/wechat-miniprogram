# Design: 课程预约功能（支持选择教练）

## Context

当前系统已有场馆预约功能，用户可以预约场地进行自主活动。课程预约是在此基础上的增强功能，允许用户预约由专业教练指导的课程。

### 约束条件
- 必须符合微信小程序开发规范
- 复用现有的用户认证体系
- 与现有场馆预约功能保持 UI 风格一致
- 使用微信云开发

## Goals / Non-Goals

### Goals
- 用户可以浏览和预约课程
- 用户可以在预约时选择喜欢的教练
- 管理员可以管理教练和课程信息
- 支持课程人数限制和名额管理

### Non-Goals
- 不实现在线支付功能（首版）
- 不实现课程评价/评分功能（首版）
- 不实现教练端独立功能（教练通过管理后台查看）
- 不实现课程视频/直播功能

## Decisions

### 1. 数据模型设计

**决定**: 采用四个集合分离存储

```
coaches (教练)
├── _id
├── name (姓名)
├── avatar (头像)
├── title (职称/头衔)
├── introduction (简介)
├── specialties (擅长领域数组)
├── certifications (资质证书数组)
├── rating (评分，预留)
├── enabled (是否启用)
├── createTime
└── updateTime

courses (课程)
├── _id
├── name (课程名称)
├── type (课程类型：yoga/swimming/basketball等)
├── description (课程描述)
├── duration (时长，分钟)
├── price (价格)
├── maxStudents (最大人数)
├── coachIds (可授课的教练ID数组)
├── venueId (关联场馆，可选)
├── images (课程图片)
├── enabled (是否启用)
├── createTime
└── updateTime

course_schedules (课程排期)
├── _id
├── courseId (课程ID)
├── coachId (教练ID)
├── date (日期)
├── startTime (开始时间)
├── endTime (结束时间)
├── venueId (场馆ID，可选)
├── maxStudents (本场次最大人数)
├── bookedCount (已预约人数)
├── status (状态：available/full/cancelled)
├── createTime
└── updateTime

course_bookings (课程预约)
├── _id
├── _openid (用户openid)
├── scheduleId (排期ID)
├── courseId (课程ID)
├── courseName (课程名称，冗余)
├── coachId (教练ID)
├── coachName (教练姓名，冗余)
├── date (日期)
├── startTime (开始时间)
├── endTime (结束时间)
├── status (状态：pending/confirmed/cancelled/completed)
├── userName (预约人姓名)
├── userPhone (预约人电话)
├── createTime
└── updateTime
```

**原因**:
- 教练和课程分离，支持多对多关系
- 排期独立管理，便于灵活安排
- 预约记录冗余关键字段，减少查询关联

### 2. 预约流程设计

**决定**: 采用「课程优先」的预约流程

```
用户流程：
1. 浏览课程列表 → 2. 选择课程 → 3. 查看课程排期 
→ 4. 选择时间和教练 → 5. 填写信息 → 6. 确认预约
```

**原因**:
- 用户通常先关注想学什么，再选择教练
- 课程维度便于按类型筛选
- 与现有场馆预约流程保持一致性

**备选方案**: 「教练优先」流程（先选教练再看其课程），适合教练知名度高的场景

### 3. 页面结构设计

**决定**: 新增独立的课程模块入口

```
pages/
├── course/
│   ├── list/           # 课程列表
│   ├── detail/         # 课程详情（含排期选择）
│   └── booking/        # 预约确认
├── coach/
│   ├── list/           # 教练列表
│   └── detail/         # 教练详情（含其课程）
├── user/
│   └── courses/        # 我的课程预约
└── admin/
    ├── coaches/        # 教练管理
    ├── courses/        # 课程管理
    └── course-bookings/ # 课程预约管理
```

**原因**:
- 与现有 venue 模块结构保持一致
- 教练和课程可独立浏览
- 管理后台功能分离清晰

### 4. TabBar 调整

**决定**: 保持现有4个 Tab 不变，课程入口放在首页

```
首页新增入口：
┌─────────────────────────┐
│  [场馆预约] [课程预约]   │  ← 两个并列入口
│  [停车登记] [更多...]    │
└─────────────────────────┘
```

**原因**:
- 微信小程序 TabBar 最多5个，当前已有4个
- 首页入口方式更灵活，便于后续扩展
- 减少用户学习成本

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    微信小程序前端                             │
├─────────────┬─────────────┬─────────────┬──────────────────┤
│   首页      │  课程模块    │  教练模块    │   个人中心       │
│  - 课程入口 │  - 课程列表  │  - 教练列表  │   - 我的课程     │
│             │  - 课程详情  │  - 教练详情  │                  │
│             │  - 预约确认  │             │                  │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    微信云开发                                │
├─────────────────────────────────────────────────────────────┤
│  云函数                                                      │
│  - coach: 教练CRUD/查询                                      │
│  - course: 课程CRUD/排期管理/预约创建取消                     │
├─────────────────────────────────────────────────────────────┤
│  云数据库                                                    │
│  - coaches / courses / course_schedules / course_bookings   │
└─────────────────────────────────────────────────────────────┘
```

## Risks / Trade-offs

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 并发预约导致超额 | 课程人满但仍有人预约成功 | 使用事务确保名额扣减原子性 |
| 教练请假导致课程取消 | 已预约用户受影响 | 管理员可批量取消并通知用户 |
| 数据冗余导致不一致 | 教练改名后预约记录显示旧名 | 历史记录保持原样，接受这种trade-off |

## Open Questions

1. 是否需要支持课程收藏/关注教练功能？（建议后续版本）
2. 是否需要课程提醒通知？（可使用微信订阅消息）
3. 是否需要签到功能？（建议后续版本）
