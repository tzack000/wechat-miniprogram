# 云函数部署流程图

## 📊 完整部署流程

```
┌─────────────────────────────────────────────────────────────┐
│                     开始部署                                 │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤1: 打开微信开发者工具                                    │
│  ✓ 确保已登录                                               │
│  ✓ 打开项目                                                 │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤2: 定位云函数目录                                       │
│  左侧文件树 → cloudfunctions → initAllTestData              │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤3: 部署云函数                                          │
│  右键 initAllTestData 文件夹                                │
│  → 选择「上传并部署：云端安装依赖」                          │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  等待部署...                                                │
│  ⏳ 正在上传文件                                            │
│  ⏳ 正在安装依赖                                            │
│  ⏳ 正在部署                                                │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
          ┌───────┴───────┐
          │  部署成功？    │
          └───┬───────┬───┘
              │       │
          ✅ 是     ❌ 否
              │       │
              │       └──────────────────┐
              │                          ▼
              │              ┌──────────────────────────┐
              │              │ 检查错误信息              │
              │              │ • 查看控制台日志          │
              │              │ • 检查网络连接            │
              │              │ • 确认环境权限            │
              │              └──────────┬───────────────┘
              │                         │
              │                         │ 重试
              │                         │
              │              ┌──────────┴───────────────┐
              │              │ 尝试本地安装依赖方式      │
              │              │ cd cloudfunctions/...     │
              │              │ npm install              │
              │              └──────────┬───────────────┘
              │                         │
              │                         └─────┐
              │                               │
              ▼                               ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤4: 打开云开发控制台                                     │
│  点击工具栏「云开发」→「云函数」                             │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤5: 测试云函数                                          │
│  找到 initAllTestData → 点击「测试」                        │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤6: 输入测试参数                                        │
│  {                                                          │
│    "action": "all",                                         │
│    "clear": true                                            │
│  }                                                          │
│  点击「运行测试」                                            │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  执行初始化...                                              │
│  ⏳ 清除现有数据                                            │
│  ⏳ 初始化用户数据                                          │
│  ⏳ 初始化场馆数据                                          │
│  ⏳ 初始化教练数据                                          │
│  ⏳ 初始化课程数据                                          │
│  ⏳ 初始化排期数据                                          │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
          ┌───────┴───────┐
          │  初始化成功？  │
          └───┬───────┬───┘
              │       │
          ✅ 是     ❌ 否
              │       │
              │       └──────────────────┐
              │                          ▼
              │              ┌──────────────────────────┐
              │              │ 检查错误                 │
              │              │ • 数据库集合是否存在      │
              │              │ • 权限设置是否正确        │
              │              │ • 查看云函数日志          │
              │              └──────────┬───────────────┘
              │                         │
              │                         │ 修复后重试
              │                         │
              │                         └─────┐
              │                               │
              ▼                               ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤7: 验证数据                                            │
│  云开发控制台 → 数据库                                       │
│  ✓ users: 3条                                              │
│  ✓ venues: 10条                                            │
│  ✓ coaches: 5条                                            │
│  ✓ courses: 10条                                           │
│  ✓ course_schedules: 210条                                 │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│  步骤8: 测试小程序功能                                       │
│  ✓ 场馆列表显示正常                                         │
│  ✓ 课程列表显示正常                                         │
│  ✓ 预约功能正常                                             │
└─────────────────┬───────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│                 🎉 部署完成！                                │
│           可以开始使用小程序了！                              │
└─────────────────────────────────────────────────────────────┘
```

## 🎯 关键检查点

### 检查点 1: 部署成功确认
```
✅ 底部控制台显示"部署成功"
✅ 文件夹图标变为 ☁️
✅ 文件夹名称前有 🟢
```

### 检查点 2: 云函数可见性
```
✅ 云开发控制台能看到 initAllTestData
✅ 状态显示为"正常"
✅ 可以点击进入详情页
```

### 检查点 3: 测试执行成功
```
✅ 返回 "success": true
✅ summary 中列出所有初始化项
✅ 没有错误信息
```

### 检查点 4: 数据验证
```
✅ 所有集合都有数据
✅ 数据量符合预期
✅ 数据结构正确
```

## ⏱️ 预计时间

| 步骤 | 预计时间 |
|------|---------|
| 部署云函数 | 30秒 - 1分钟 |
| 打开控制台 | 10秒 |
| 执行初始化 | 5-10秒 |
| 验证数据 | 30秒 |
| **总计** | **约2-3分钟** |

## 🔧 故障排除流程

```
┌─────────────┐
│  遇到错误？  │
└──────┬──────┘
       │
       ▼
┌─────────────────────────┐
│ 1. 查看错误类型          │
└──────┬──────────────────┘
       │
       ├─→ 部署失败 ─→ 检查权限和网络 ─→ 重新部署
       │
       ├─→ 依赖安装失败 ─→ 本地安装依赖 ─→ 重新上传
       │
       ├─→ 找不到云函数 ─→ 刷新列表 ─→ 检查部署状态
       │
       ├─→ 初始化超时 ─→ 分批初始化 ─→ 使用modules参数
       │
       └─→ 数据不存在 ─→ 创建集合 ─→ 重新初始化
```

## 📋 部署前检查清单

```
[ ] 微信开发者工具已安装
[ ] 已登录微信账号
[ ] 项目已打开
[ ] 云开发环境已开通
[ ] 代码已更新到最新版本
[ ] 网络连接正常
```

## 📋 部署后检查清单

```
[ ] 云函数部署成功（图标为☁️）
[ ] 能在云开发控制台看到
[ ] 测试调用成功
[ ] 所有数据集合已创建
[ ] 数据已成功初始化
[ ] 数据量正确
[ ] 小程序能正常访问数据
```

## 🎓 最佳实践

1. **首次部署**：使用"云端安装依赖"
2. **重复部署**：如果代码没改动，可以用"所有文件"
3. **大量数据**：分批初始化，避免超时
4. **生产环境**：不要使用 `clear: true`
5. **定期备份**：重要数据请先备份

## 🔗 快速链接

- [3分钟快速部署](QUICK_DEPLOY.md)
- [详细部署指南](DEPLOY_CLOUD_FUNCTION_GUIDE.md)
- [云函数文档](cloudfunctions/initAllTestData/README.md)
- [初始化指南](docs/INIT_TEST_DATA.md)
